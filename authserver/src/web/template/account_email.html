{{define "title"}}{{ .branding.AppName }}{{end}}
{{define "head"}}

<script>

    document.addEventListener('DOMContentLoaded', function () {

        var emailInput = document.getElementById("email");
        emailInput.addEventListener("input", function () {   
            
            verificationPanel = document.getElementById("verification-panel");
            if(verificationPanel != null) {

                const originalEmail = "{{.accountEmail.Email}}";    

                if (emailInput.value == originalEmail) {
                    verificationPanel.classList.remove("hidden"); // show
                } else {
                    verificationPanel.classList.add("hidden"); // hide
                }
            }            
        });
    });

    function sendVerificationEmail(evt) {

        evt.preventDefault();

        document.getElementById("spinner").classList.remove("hidden");
        document.getElementById("btnSendVerificationEmail").classList.add("btn-disabled");

        try {
            fetch("/account/email-send-verification", {
                method: "POST",
                body: JSON.stringify({}),
                headers: {
                    "Content-type": "application/json; charset=UTF-8",
                    "X-CSRF-Token": document.getElementsByName("gorilla.csrf.Token")[0].value
                }
            })
            .then((response) => {

                if (!response.ok) {
                    response.json().then(err => { showDialog("Server error", err.error_description); })                    
                } else {
                    return response.json()
                }
            })
            .then((result) => {

                document.getElementById("spinner").classList.add("hidden");
                document.getElementById("btnSendVerificationEmail").classList.remove("btn-disabled");

                if(result.RequiresAuth) {
                    showDialog("Session expired", "Your authentication session has expired. To continue, please refresh the page and re-authenticate to start a new session.");                
                } else if(result.EmailVerified) {
                    showDialog("Email is already verified", "It appears that your email address is already verified. You may want to refresh the page to view the updated status.");
                } else if(result.TooManyRequests) {
                    showDialog("Too many requests", "A request to send a verification email was made recently. Please wait for " + result.WaitInSeconds + " seconds before requesting another one.");
                } else if(result.EmailVerificationSent) {
                    showDialog("Email verification sent", "An email verification link has been dispatched to your inbox. To complete the process, please check your inbox and your spam/junk folder. Locate the confirmation link within the email and click it to verify your email address.");
                }

            });
        } catch (error) {
            showDialog("Error", "An unexpected error has occurred: " + error);
        }
    }

    function showDialog(title, message) {
        document.getElementById("dialog-title").innerText = title;
        document.getElementById("dialog-message").innerText = message;
        document.getElementById("modalDialog").showModal();
    }
</script>

{{end}}

{{define "body"}}

<div class="p-2">
    <h3 class="text-2xl font-bold text-center">{{ .branding.AppName }}</h3>
</div>




<div class="grid grid-cols-5 p-2 md:min-h-[700px]">

    {{template "nav" "email"}}

    <div class="col-span-5 md:col-span-4">
        <div class="p-1 m-2">

            <form id="form-email" action="/account/email" method="post">

                <div class="grid grid-cols-1 md:grid-cols-3 md:p-3">
                    <div class="form-control w-full max-w-xs col-span-1 md:col-span-1">
                        <label class="label">
                            <span class="label-text">Email</span>
                        </label>
                        <input type="text" id="email" name="email" class="input input-bordered w-full max-w-xs"
                            value="{{.accountEmail.Email}}" />
                        
                    </div>

                    <div class="form-control w-full max-w-xs col-span-1 md:col-span-2">
                        <label class="label">
                            <span class="label-text">Email confirmation</span>
                        </label>
                        <input type="text" id="emailConfirmation" name="emailConfirmation"
                            class="input input-bordered w-full max-w-xs" value="{{.accountEmail.EmailConfirmation}}" />
                    </div>
                </div>

                <div class="mt-3 md:p-3">
                    {{if .error}}
                        <div class="border border-red-500 p-2 rounded-box">
                            <p class="text-red-500">{{.error.Description}}</p>
                        </div>                        
                    {{end}}

                    {{ .csrfField }}
                    {{if .emailSavedSuccessfully}}
                        <div class="border p-2 rounded-box w-fit">
                            <p>&#10004; Email updated successfully</p>
                        </div>
                    {{end}}
                    <button class="btn btn-primary mt-4">Update email</button>                 
                </div>                

            </form>

            {{if and (not .error) .accountEmail.Email}}
                <div id="verification-panel" class="mt-4 md:ml-2 p-6 border rounded-box w-fit">
                    {{ if .accountEmail.EmailVerified}}
                        <p>&#10004; Your email is verified</p>
                    {{else}} 
                        <p>&#9888; Email verification pending</p>
                        <p>You can verify your email by clicking the button below.</p>
                        <button onclick="sendVerificationEmail(event);" id="btnSendVerificationEmail"
                            class="btn btn-sm btn-primary mt-2"><i class="gg-mail"></i> Send verification email</button>  <span id="spinner" class="loading loading-spinner text-primary hidden"></span>
                    {{end}}
                </div>
            {{end}}

        </div>

    </div>
</div>

<dialog id="modalDialog" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg" id="dialog-title"></h3>
        <p class="py-4" id="dialog-message"></p>
        <div class="modal-action">
            <form method="dialog">                
                <button class="btn">Close</button>
            </form>
        </div>
    </div>
</dialog>

{{end}}